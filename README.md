# Protocol Buffers Filter

The [pbf](https://pkg.go.dev/github.com/ninchat/pbf) Go package implements an
interpreter for a custom bytecode format.  A bytecode program defines a filter
for a [Protocol Buffers](https://developers.google.com/protocol-buffers)
(protobuf) message type.  It can be successively applied to protobuf message
data, yielding boolean results.

The application doing the filtering doesn't need any prior information about
the specific message types, as the bytecode includes all necessary details.  In
other words, the application doesn't need to include code generated by the
protobuf compiler.

Conversely, when constructing the bytecode program, message type information is
necessary.  The [field](https://pkg.go.dev/github.com/ninchat/pbf/field) and
[op](https://pkg.go.dev/github.com/ninchat/pbf/op) Go packages, and the
[pbf](pbf.py) Python module contain definitions helpful to bytecode generators,
but comprehensive program construction tools are not provided by this project.

The test code includes a [bytecode program example](pbf_test.go).


## Performance

Filtering using PBF (BenchmarkFilter) is 33% faster than using Go code
generated with protoc 3.6.1 and protoc-gen-go 1.27.1 (BenchmarkProtocGo), and
twice as slow as generated C++ code (BenchmarkProtocCXX):

```
goos: linux
goarch: amd64
pkg: github.com/ninchat/pbf
cpu: Intel(R) Core(TM) i7-3770 CPU @ 3.40GHz
BenchmarkPrepare      358893          3136 ns/op                        2420 B/op         18 allocs/op
BenchmarkFilter       671335          1751 ns/op     114.20 MB/s           0 B/op          0 allocs/op
BenchmarkProtocGo     512204          2331 ns/op      85.81 MB/s         776 B/op         26 allocs/op
BenchmarkProtocCXX   1221612           857.2 ns/op   233.33 MB/s
```

PBF doesn't add pressure on the garbage collector due to being virtually
allocation-free.  It needs to allocate maps to keep track of unpacked repeated
fields, but they are shared between iterations.

BenchmarkPrepare parses and verifies the filter bytecode.  It needs to be done
only once per program (message type).


## Contact

Developed by [Ninchat](https://ninchat.com/contact).

